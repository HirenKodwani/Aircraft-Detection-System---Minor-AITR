<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AERIES - Aerial Recognition & Intelligence System</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #2c3e50;
            overflow: hidden;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            padding: 1rem 2rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            letter-spacing: 0.05em;
        }

        .header .subtitle {
            font-size: 0.75rem;
            color: #bfdbfe;
            font-weight: 400;
        }

        .status-bar {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            font-size: 0.875rem;
            color: white;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ef4444;
        }

        .status-dot.connected {
            background: #10b981;
        }

        /* Main Layout */
        .container {
            display: grid;
            grid-template-columns: 1.2fr 1fr 0.8fr;
            height: calc(100vh - 65px);
            gap: 1rem;
            padding: 1rem;
        }

        .panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            padding: 1rem 1.5rem;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            font-weight: 600;
            color: #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        /* Camera Panel */
        #liveFrame {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
            border-radius: 8px;
        }

        .controls {
            padding: 1rem;
            background: white;
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-primary.active {
            background: #10b981;
        }

        /* Map Panel */
        #map {
            width: 100%;
            height: 100%;
        }

        .map-info {
            padding: 0.75rem 1rem;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
            font-size: 0.875rem;
            color: #64748b;
        }

        /* Detections Panel */
        .detections-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .detection-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            transition: all 0.2s;
        }

        .detection-card:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .detection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .detection-title {
            font-weight: 600;
            color: #1e293b;
            font-size: 0.9rem;
        }

        .detection-type {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .type-camera {
            background: #dbeafe;
            color: #1e40af;
        }

        .type-map {
            background: #d1fae5;
            color: #065f46;
        }

        .detection-info {
            font-size: 0.8rem;
            color: #64748b;
            line-height: 1.5;
        }

        .threat-medium {
            color: #d97706;
        }

        .threat-high {
            color: #dc2626;
        }

        .threat-none {
            color: #059669;
        }

        .no-data {
            text-align: center;
            padding: 2rem;
            color: #94a3b8;
            font-size: 0.875rem;
        }

        canvas {
            display: none;
        }

        /* Custom Aircraft Icon */
        .aircraft-marker {
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%233b82f6"><path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/></svg>');
            width: 32px;
            height: 32px;
            background-size: contain;
        }
    </style>
</head>

<body>
    <div class="header">
        <div>
            <h1>AERIES</h1>
            <div class="subtitle">Aerial Recognition & Intelligence System</div>
        </div>
        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Connecting...</span>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Camera Panel -->
        <div class="panel">
            <div class="panel-header">
                <span>Live Camera Feed</span>
            </div>
            <div class="panel-content" style="padding: 0;">
                <img id="liveFrame" alt="Camera Feed">
            </div>
            <div class="controls">
                <button id="startBtn" class="btn btn-primary">Start Detection</button>
                <span id="sessionInfo" style="font-size: 0.875rem; color: #64748b;"></span>
            </div>
        </div>

        <!-- Map Panel -->
        <div class="panel">
            <div class="panel-header">
                <span>Aerial Radar Map</span>
                <span id="aircraftCount" style="font-size: 0.875rem; color: #64748b;">0 aircraft</span>
            </div>
            <div class="panel-content" style="padding: 0;">
                <div id="map"></div>
            </div>
            <div class="map-info" id="gpsInfo">Acquiring GPS location...</div>
        </div>

        <!-- Detections Panel -->
        <div class="panel">
            <div class="panel-header">
                <span>Live Detections</span>
                <span id="detectionCount"
                    style="background: #3b82f6; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem;">0</span>
            </div>
            <div class="panel-content">
                <div id="detectionsList">
                    <div class="no-data">No detections yet. Start camera or view nearby aircraft.</div>
                </div>
            </div>
        </div>
    </div>

    <canvas id="canvas"></canvas>

    <script>
        // Map initialization
        const map = L.map('map').setView([20, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap'
        }).addTo(map);

        let userMarker = null;
        let currentLat = null;
        let currentLng = null;
        let aircraftLayer = L.layerGroup().addTo(map);

        // Custom aircraft icon
        const aircraftIcon = L.divIcon({
            className: 'aircraft-marker',
            iconSize: [32, 32],
            iconAnchor: [16, 16]
        });

        // GPS tracking
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((position) => {
                currentLat = position.coords.latitude;
                currentLng = position.coords.longitude;
                const accuracy = position.coords.accuracy;

                if (userMarker) map.removeLayer(userMarker);
                userMarker = L.marker([currentLat, currentLng]).addTo(map)
                    .bindPopup(`<b>Your Location</b><br>Accuracy: ${accuracy.toFixed(1)}m`).openPopup();

                L.circle([currentLat, currentLng], {
                    color: '#3b82f6',
                    fillColor: '#3b82f6',
                    fillOpacity: 0.1,
                    radius: accuracy
                }).addTo(map);

                map.setView([currentLat, currentLng], 10);

                document.getElementById('gpsInfo').innerHTML =
                    `Lat: ${currentLat.toFixed(6)}, Lon: ${currentLng.toFixed(6)}, Accuracy: ±${accuracy.toFixed(1)}m`;

                fetchNearbyAircraft();
            }, (error) => {
                console.error('GPS Error:', error);
                document.getElementById('gpsInfo').innerHTML =
                    '<span style="color: #ef4444;">GPS permission denied or unavailable</span>';
            }, {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            });

            navigator.geolocation.watchPosition((position) => {
                currentLat = position.coords.latitude;
                currentLng = position.coords.longitude;
                const accuracy = position.coords.accuracy;

                if (userMarker) {
                    userMarker.setLatLng([currentLat, currentLng]);
                    userMarker.setPopupContent(`<b>Your Location</b><br>Accuracy: ${accuracy.toFixed(1)}m`);
                }
            }, null, { enableHighAccuracy: true, maximumAge: 0 });
        }

        // Socket.IO connection
        const socket = io({
            transports: ['polling', 'websocket'],
            upgrade: true,
            reconnection: true,
            reconnectionAttempts: 20,
            timeout: 30000
        });

        let isDetecting = false;
        let stream = null;
        let frameInterval = null;

        socket.on('connect', () => {
            console.log('[SOCKET] Connected');
            document.getElementById('statusDot').classList.add('connected');
            document.getElementById('statusText').textContent = 'Connected';
        });

        socket.on('disconnect', () => {
            console.log('[SOCKET] Disconnected');
            document.getElementById('statusDot').classList.remove('connected');
            document.getElementById('statusText').textContent = 'Disconnected';
        });

        // Fetch nearby aircraft
        function fetchNearbyAircraft() {
            if (currentLat !== null && currentLng !== null) {
                socket.emit('get_nearby_aircraft', {
                    latitude: currentLat,
                    longitude: currentLng,
                    radius: 250
                });
            }
        }

        setInterval(fetchNearbyAircraft, 30000);

        socket.on('nearby_aircraft', (data) => {
            aircraftLayer.clearLayers();

            if (data.error) {
                console.error('Aircraft fetch error:', data.error);
                return;
            }

            const aircraft = data.aircraft || [];
            console.log(`Received ${aircraft.length} aircraft`);

            document.getElementById('aircraftCount').textContent = `${aircraft.length} aircraft`;

            aircraft.forEach(ac => {
                if (ac.lat && ac.lon) {
                    const marker = L.marker([ac.lat, ac.lon], { icon: aircraftIcon });

                    const popup = `
                        <div style="font-family: sans-serif; min-width: 200px;">
                            <b style="font-size: 14px; color: #3b82f6;">${ac.callsign || 'Unknown'}</b><br>
                            <span style="font-size: 11px; color: #666;">
                                Registration: ${ac.registration}<br>
                                Type: ${ac.type}<br>
                                Altitude: ${ac.altitude ? ac.altitude + ' ft' : 'N/A'}<br>
                                Speed: ${ac.speed ? ac.speed + ' kt' : 'N/A'}<br>
                                Heading: ${ac.track ? ac.track + '°' : 'N/A'}
                            </span>
                        </div>
                    `;

                    marker.bindPopup(popup);
                    marker.addTo(aircraftLayer);

                    // Add to detections list
                    addDetection({
                        source: 'map',
                        callsign: ac.callsign || 'Unknown',
                        registration: ac.registration,
                        type: ac.type,
                        altitude: ac.altitude,
                        speed: ac.speed
                    });
                }
            });
        });

        // Camera detection
        document.getElementById('startBtn').addEventListener('click', async () => {
            const button = document.getElementById('startBtn');

            if (!isDetecting) {
                try {
                    stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            width: { ideal: 1280 },
                            height: { ideal: 720 },
                            facingMode: 'environment'
                        }
                    });

                    const video = document.createElement('video');
                    video.srcObject = stream;
                    video.play();

                    isDetecting = true;
                    button.textContent = 'Stop Detection';
                    button.classList.add('active');

                    processFrames(video);
                } catch (error) {
                    alert('Camera permission denied! Please allow camera access.');
                }
            } else {
                if (frameInterval) {
                    clearInterval(frameInterval);
                    frameInterval = null;
                }
                if (stream) stream.getTracks().forEach(track => track.stop());
                isDetecting = false;
                button.textContent = 'Start Detection';
                button.classList.remove('active');
                document.getElementById('liveFrame').src = '';
            }
        });

        function processFrames(video) {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');

            frameInterval = setInterval(() => {
                if (!isDetecting || !video.videoWidth) return;

                const scale = 320 / video.videoWidth;
                canvas.width = 320;
                canvas.height = video.videoHeight * scale;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                const frameData = canvas.toDataURL('image/jpeg', 0.4);

                if (frameData && frameData.length > 100) {
                    socket.emit('process_frame', { frame: frameData, timestamp: Date.now() });
                }
            }, 333);
        }

        socket.on('annotated_frame', (data) => {
            document.getElementById('liveFrame').src = data.frame;

            if (data.detections && data.detections.length > 0) {
                data.detections.forEach(det => {
                    addDetection({
                        source: 'camera',
                        class: det.class,
                        confidence: det.confidence,
                        threat: det.threat
                    });
                });
            }
        });

        // Detection management
        const detectionMap = new Map();
        const MAX_DETECTIONS = 20;

        function addDetection(detection) {
            const list = document.getElementById('detectionsList');
            const detectionId = detection.source === 'camera'
                ? `cam-${detection.class}-${Date.now()}`
                : `map-${detection.callsign}-${Date.now()}`;

            if (list.querySelector('.no-data')) {
                list.innerHTML = '';
            }

            const card = document.createElement('div');
            card.className = 'detection-card';
            card.dataset.id = detectionId;

            if (detection.source === 'camera') {
                card.innerHTML = `
                    <div class="detection-header">
                        <span class="detection-title">${detection.class.toUpperCase()}</span>
                        <span class="detection-type type-camera">CAMERA</span>
                    </div>
                    <div class="detection-info">
                        Confidence: ${Math.round(detection.confidence * 100)}%<br>
                        <span class="threat-${detection.threat}">Threat: ${detection.threat.toUpperCase()}</span><br>
                        <small>${new Date().toLocaleTimeString()}</small>
                    </div>
                `;
            } else {
                card.innerHTML = `
                    <div class="detection-header">
                        <span class="detection-title">${detection.callsign}</span>
                        <span class="detection-type type-map">MAP</span>
                    </div>
                    <div class="detection-info">
                        Registration: ${detection.registration}<br>
                        Type: ${detection.type}<br>
                        Altitude: ${detection.altitude ? detection.altitude + ' ft' : 'N/A'}<br>
                        Speed: ${detection.speed ? detection.speed + ' kt' : 'N/A'}
                    </div>
                `;
            }

            list.insertBefore(card, list.firstChild);

            // Limit to MAX_DETECTIONS
            while (list.children.length > MAX_DETECTIONS) {
                list.removeChild(list.lastChild);
            }

            updateDetectionCount();
        }

        function updateDetectionCount() {
            const count = document.getElementById('detectionsList').children.length;
            document.getElementById('detectionCount').textContent = count > 0 ? count : '0';
        }
    </script>
</body>

</html>